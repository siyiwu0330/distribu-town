# 多项交易UX优化

## 问题描述

用户在处理多项交易时遇到了困惑：

### 问题1：无法查看自己发起的交易

```bash
# 用户发起了两个交易
[Day 1 - noon] > trade node1 buy wheat 5 50
✓ 交易请求已发送

[Day 1 - noon] > trade node1 sell bread 2 36
✓ 交易请求已发送

# 想查看自己发起的交易状态
[Day 1 - noon] > trades
没有待处理的交易请求  # ❌ 误导！只显示"收到的"请求

# 用户不知道如何查看自己发起的交易
```

**原因**：
- `trades` 命令只显示"收到的"交易请求（其他人发给你的）
- 没有命令可以查看"发起的"交易请求（你发给别人的）
- 用户在多个交易并发时，无法追踪自己的交易状态

---

## 解决方案

### 新增 `mytrades` 命令

添加专门的命令来查看自己发起的交易请求。

#### 命令别名
```bash
mytrades    # 主命令
pending     # 别名（更语义化）
```

#### 功能对比

| 命令 | 显示内容 | 用途 |
|------|---------|------|
| `trades` | 收到的交易请求（别人发给你） | 接受/拒绝交易 |
| `mytrades` | 发起的交易请求（你发给别人） | 查看状态、确认/取消 |

---

## 使用示例

### 场景：同时发起多项交易

```bash
# Terminal 2 (test2 - 发起方)
[Day 1 - noon] > trade node1 buy wheat 5 50
✓ 交易请求已发送
  你想从 node1 购买 5x wheat, 出价 50金币

[Day 1 - noon] > trade node1 sell bread 2 36
✓ 交易请求已发送
  你想向 node1 出售 2x bread, 要价 36金币

# ✓ 新功能：查看自己发起的交易
[Day 1 - noon] > mytrades

============================================================
  你发起的交易请求
============================================================

[1] 交易ID: trade_0
    对象: node1
    类型: 你想购买
    物品: 5x wheat
    出价: 50金币
    状态: ⏳ 等待对方接受
    操作: 等待对方响应或 cancel trade_0 取消

[2] 交易ID: trade_1
    对象: node1
    类型: 你想出售
    物品: 2x bread
    要价: 36金币
    状态: ⏳ 等待对方接受
    操作: 等待对方响应或 cancel trade_1 取消
============================================================

# node1接受了trade_0
🎉 对方已接受你的交易请求！[trade_0]
💡 输入 'confirm trade_0' 完成交易

[Day 1 - noon] > mytrades

============================================================
  你发起的交易请求
============================================================

[1] 交易ID: trade_0
    对象: node1
    类型: 你想购买
    物品: 5x wheat
    出价: 50金币
    状态: ✓ 对方已接受  # ✓ 状态已更新
    操作: confirm trade_0 完成交易

[2] 交易ID: trade_1
    对象: node1
    类型: 你想出售
    物品: 2x bread
    要价: 36金币
    状态: ⏳ 等待对方接受
    操作: 等待对方响应或 cancel trade_1 取消
============================================================

# 完成第一个交易
[Day 1 - noon] > confirm trade_0
✓ 交易完成！

[Day 1 - noon] > mytrades

============================================================
  你发起的交易请求
============================================================

[1] 交易ID: trade_1  # ✓ trade_0已完成并清理
    对象: node1
    类型: 你想出售
    物品: 2x bread
    要价: 36金币
    状态: ✓ 对方已接受
    操作: confirm trade_1 完成交易
============================================================

[Day 1 - noon] > confirm trade_1
✓ 交易完成！

[Day 1 - noon] > mytrades
你没有发起任何待处理的交易  # ✓ 所有交易已完成
```

---

### 场景：区分收到和发起的交易

```bash
# Terminal 1 (node1)
[Day 1 - noon] > trades  # 查看收到的请求

============================================================
  收到的交易请求
============================================================

[1] 交易ID: trade_0
    来自: test2
    类型: 对方想购买
    物品: 5x wheat
    出价: 50金币
    状态: ⏳ 待处理
    操作: accept trade_0 或 reject trade_0
============================================================

[Day 1 - noon] > mytrades  # 查看自己发起的请求
你没有发起任何待处理的交易
```

---

## 命令详解

### mytrades 输出格式

```
============================================================
  你发起的交易请求
============================================================

[序号] 交易ID: trade_id
    对象: 目标节点
    类型: 你想购买/出售
    物品: 数量x 物品名
    出价/要价: XX金币
    状态: ⏳ 等待对方接受 / ✓ 对方已接受
    操作: 相应的操作提示
============================================================
```

### 状态说明

| 状态 | 含义 | 可执行操作 |
|------|------|-----------|
| ⏳ 等待对方接受 | 交易请求已发送，等待对方响应 | `cancel <ID>` 取消 |
| ✓ 对方已接受 | 对方已接受，可以完成交易 | `confirm <ID>` 完成 |

---

## 命令列表更新

### 交易相关命令

```bash
# 发起交易
trade <村民> buy <物品> <数量> <价格>   # 购买
trade <村民> sell <物品> <数量> <价格>  # 出售

# 查看交易
trades          # 查看收到的交易请求（别人发给你）
mytrades        # 查看发起的交易请求（你发给别人）

# 处理收到的请求
accept <ID>     # 接受
reject <ID>     # 拒绝

# 处理发起的请求
confirm [ID]    # 确认完成
cancel [ID]     # 取消
```

### 工作流程

#### 作为发起方

```bash
1. trade node1 buy wheat 5 50    # 发起交易
2. mytrades                       # 查看状态
3. confirm trade_0                # 对方接受后，完成交易
```

#### 作为接收方

```bash
1. trades                         # 查看收到的请求
2. accept trade_0                 # 接受交易
3. # 等待对方confirm
```

---

## 实现细节

### 数据来源

- **trades**: 从 `GET /trade/pending` 获取数据（服务端存储）
- **mytrades**: 从 `self.pending_trades` 获取数据（客户端存储）

### 状态同步

```python
def show_my_pending_trades(self):
    """查看自己发起的待处理交易"""
    if not self.pending_trades:
        print("\n你没有发起任何待处理的交易")
        return
    
    for trade_id, trade in self.pending_trades.items():
        status = trade.get('status', 'pending')
        
        # 根据状态显示
        if status == 'ready_to_confirm':
            print(f"    状态: ✓ 对方已接受")
            print(f"    操作: confirm {trade_id} 完成交易")
        else:
            print(f"    状态: ⏳ 等待对方接受")
            print(f"    操作: 等待对方响应或 cancel {trade_id} 取消")
```

### 自动状态更新

通过 `check_my_pending_trade_status()` 自动检测对方是否接受：
- 每次用户输入命令前检查
- 如果发现对方已接受，自动更新状态为 `ready_to_confirm`
- 同时显示醒目的提示

---

## 用户体验提升

### 修复前的困惑

```bash
# 用户发起交易后
[Day 1] > trade node1 buy wheat 5 50
✓ 交易请求已发送

# 想查看状态
[Day 1] > trades
没有待处理的交易请求  # ❌ 用户：？？？我刚发的呢？

# 不知道如何查看自己发起的交易
```

### 修复后的清晰流程

```bash
# 用户发起交易后
[Day 1] > trade node1 buy wheat 5 50
✓ 交易请求已发送

# 查看自己发起的交易
[Day 1] > mytrades
[1] 交易ID: trade_0
    状态: ⏳ 等待对方接受  # ✓ 清晰！

# 对方接受后
🎉 对方已接受你的交易请求！[trade_0]
💡 输入 'confirm trade_0' 完成交易  # ✓ 明确指引！

# 再次查看
[Day 1] > mytrades
[1] 交易ID: trade_0
    状态: ✓ 对方已接受  # ✓ 状态已更新！
    操作: confirm trade_0 完成交易
```

---

## 帮助文档更新

```bash
[Day 1] > help

村民间交易（P2P，不经过协调器）:
  trade <村民> buy <物品> <数量> <价格>  - 向其他村民购买
  trade <村民> sell <物品> <数量> <价格> - 向其他村民出售
  trades          - 查看收到的交易请求  # ← 明确说明
  mytrades        - 查看自己发起的交易请求  # ← 新命令
  accept <ID>     - 接受指定的交易请求
  reject <ID>     - 拒绝指定的交易请求
  confirm [ID]    - 确认并完成自己发起的交易（可选指定ID）
  cancel [ID]     - 取消自己发起的交易（可选指定ID）
  
  示例: trade bob buy wheat 10 100  → 向bob发起购买请求
        trades                       → 查看收到的请求
        mytrades                     → 查看自己发起的请求  # ← 新示例
        accept trade_0               → 接受交易
        confirm trade_0              → 发起方完成交易（指定ID）
```

---

## 相关文件

- `architecture2_rest/interactive_cli.py`
  - `show_my_pending_trades()` - 新增方法
  - 命令解析 - 添加 `mytrades` 和 `pending` 别名
  - 帮助文档 - 更新说明

---

## 总结

✅ **解决了用户困惑**: 明确区分"收到的"和"发起的"交易  
✅ **提升了可见性**: 用户可以随时查看自己发起的交易状态  
✅ **改善了UX**: 清晰的状态标记和操作提示  
✅ **支持并发交易**: 多项交易时，一目了然地查看所有状态  

现在用户在处理多项交易时不会再困惑！🎉

