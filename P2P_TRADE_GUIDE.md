# 村民间P2P交易指南

## 🤝 点对点交易机制

村民间的交易是**真正的P2P（点对点）通信**，不经过协调器，直接在两个村民节点之间进行。

### 与商人交易的区别

| 特性 | 商人交易 | 村民间交易 |
|------|---------|-----------|
| 通信方式 | 单向请求 | 双向协商 |
| 价格 | 固定 | 自由协商 |
| 经过协调器 | ❌ 不经过 | ❌ 不经过（P2P） |
| 需要对方确认 | ❌ 不需要 | ✅ 需要 |

---

## 📖 使用方法

### 完整交易流程

**Alice想从Bob购买小麦：**

```
Alice终端                        Bob终端（节点日志）
────────────────────────────────────────────────────────────
> trade bob buy wheat 10 100
📤 向 bob 发送交易请求...
✓ 交易请求已发送               [Villager-bob] 收到交易请求:
  你想从 bob 购买 10x wheat        Alice 想购买 10x wheat, 
  出价 100金币                     出价 100金币
                                  
⏳ 等待 bob 接受或拒绝...
💡 提示: 对方需要在CLI中输入
      'accept' 或 'reject' 命令
                                Bob终端（CLI）
                                ────────────────
                                （Bob看到节点日志提示）
                                （Bob检查自己是否有小麦）
                                > info
                                📦 物品:
                                   - wheat: 15
                                   - ...
                                   
                                （Bob同意交易）
                                （暂时简化：Alice直接confirm）

> confirm
✓ 交易完成！                    [Villager-bob] 交易完成:
  你从 bob 购买了 10x wheat       出售 10x wheat 给 Alice,
  支付: 100金币                   获得 100金币

==================================================
  Alice - farmer
==================================================
💰 货币: 70  (原来170 - 100)
📦 物品:
   - wheat: 10  (新增)
==================================================
```

---

## 🎮 使用示例

### 示例1：农夫向厨师出售小麦

**Alice（农夫）生产了小麦，Bob（厨师）需要小麦：**

**Alice终端：**
```bash
# 1. 生产小麦
> buy seed 5
> produce
> produce
> produce
> info
📦 物品:
   - wheat: 15

# 2. 向Bob出售（要价80金币）
> trade bob sell wheat 10 80
✓ 交易请求已发送
  你想向 bob 出售 10x wheat, 要价 80金币

⏳ 等待 bob 接受...
```

**Bob终端：**
```bash
# Bob的节点日志会显示：
[Villager-bob] 收到交易请求:
  Alice 想出售 10x wheat, 要价 80金币

# Bob检查自己的钱
> info
💰 货币: 150

# Bob觉得价格合理，通过confirm接受
# （简化版：需要Alice来confirm完成）
```

**Alice终端（继续）：**
```bash
# Alice确认交易
> confirm
✓ 交易完成！
  你向 bob 出售了 10x wheat
  获得: 80金币

==================================================
  Alice - farmer
==================================================
💰 货币: 170  (90 + 80)
📦 物品:
   - seed: 2
   - wheat: 5  (15 - 10)
==================================================
```

---

### 示例2：木工出售房屋

**Charlie（木工）建好房屋，想卖给Alice：**

```bash
# Charlie终端
> trade alice sell house 1 150
✓ 交易请求已发送
  你想向 alice 出售 1x house, 要价 150金币

> confirm
✓ 交易完成！
  你向 alice 出售了 1x house
  获得: 150金币
```

**Alice终端：**
```bash
# Alice的节点日志会显示交易请求

# Alice查看状态，确认有足够的钱
> info
💰 货币: 200

# 交易自动完成（简化版）
# Alice现在有房子了，晚上可以免费睡觉！
```

---

## 🎯 命令详解

### 发起交易

**语法：**
```
trade <目标村民> <buy|sell> <物品> <数量> <价格>
```

**示例：**
```bash
# 向bob购买10个小麦，出价100
trade bob buy wheat 10 100

# 向alice出售5个面包，要价75
trade alice sell bread 5 75

# 向charlie购买1个房子，出价150
trade charlie buy house 1 150
```

### 查看可交易的村民

```bash
# 查看所有在线的村民
> status
总村民数: 3
...

# 或者尝试交易时，如果节点不存在会提示
> trade unknown buy wheat 1 10
✗ 找不到村民节点: unknown
可用的村民: alice, bob, charlie
```

### 确认交易

```bash
> confirm
✓ 交易完成！
```

### 取消交易

```bash
> cancel
✓ 已取消与 bob 的交易
```

---

## 🔍 技术细节

### P2P通信流程

```
Alice节点 (5002)              Bob节点 (5003)
    │                              │
    │  POST /trade/request         │
    │─────────────────────────────>│
    │  {from: Alice,               │
    │   item: wheat,               │
    │   quantity: 10,              │
    │   price: 100,                │
    │   offer_type: buy}           │
    │                              │
    │                              │ [存储请求]
    │                              │ [打印日志]
    │                              │
    │  (Alice执行confirm)          │
    │                              │
    │  POST /trade/complete        │
    │─────────────────────────────>│
    │  {from: Alice,               │
    │   item: wheat,               │
    │   type: buy}                 │
    │                              │
    │                              │ [检查资源]
    │                              │ [转移物品]
    │       200 OK + 新状态        │
    │<─────────────────────────────│
    │                              │
    │ [更新自己状态]               │
    │ [完成交易]                   │
```

### 为什么不经过协调器？

**协调器的职责：**
- ✅ 全局时间同步
- ✅ 节点注册和发现
- ✅ 同步屏障控制

**不需要协调器的操作：**
- ❌ 两个村民间的物品交换
- ❌ 单个村民的状态查询
- ❌ 与商人的交易

**优势：**
1. **减少中心化瓶颈** - 协调器不会成为性能瓶颈
2. **更快的响应** - 直接通信，延迟更低
3. **真实的分布式** - 模拟真实的P2P网络
4. **更好的扩展性** - 可以支持更多村民

---

## 💡 使用技巧

### 1. 价格协商

虽然当前版本是一方定价，但你可以：
- 在群聊中协商价格
- 如果对方不接受，取消后重新发起
- 参考商人价格（但可以更灵活）

### 2. 批量交易

```bash
# Alice连续出售
> trade bob sell wheat 10 80
> confirm
> trade charlie sell wheat 5 40
> confirm
```

### 3. 检查对方是否在线

```bash
> status
# 查看哪些村民节点在线
```

### 4. 交易前检查资源

```bash
# 发起交易前先检查自己的资源
> info
💰 货币: 100
📦 物品:
   - wheat: 20

# 确认有足够资源后再交易
> trade bob sell wheat 15 120
```

---

## 📊 经济系统建议

### 参考价格

基于商人价格，村民间可以更灵活：

| 物品 | 商人收购 | 建议村民间 |
|------|---------|-----------|
| 小麦 | 8金币 | 8-12金币 |
| 面包 | 15金币 | 15-20金币 |
| 房屋 | 150金币 | 120-180金币 |

### 交易策略

**农夫（生产小麦）：**
- 直接卖给商人：8金币/个
- 卖给厨师：可以10金币/个（双赢）

**厨师（制作面包）：**
- 从农夫买小麦：10金币/个（比商人便宜）
- 卖面包给商人：15金币/个
- 利润更高！

**木工（建造房屋）：**
- 建造成本：木材50金币（10x5）
- 卖给村民：120-150金币
- 利润可观！

---

## 🚀 完整示例场景

### 场景：三方经济循环

**1. Alice（农夫）生产小麦**
```bash
> buy seed 5
> produce x3
> info
物品: wheat: 15
```

**2. Alice卖给Bob（厨师）**
```bash
> trade bob sell wheat 12 100
> confirm
获得: 100金币
```

**3. Bob制作面包**
```bash
> produce x4
> info
物品: bread: 8
```

**4. Bob卖面包给Charlie（木工）**
```bash
> trade charlie sell bread 5 80
> confirm
获得: 80金币
```

**5. Charlie建造房屋**
```bash
> buy wood 20
> produce
> info
物品: house: 1
```

**6. Charlie卖房子给Alice**
```bash
> trade alice sell house 1 140
> confirm
获得: 140金币
```

**结果：**
- Alice: 有房子了，可以免费睡觉！
- Bob: 赚了钱，可以继续买小麦
- Charlie: 赚了钱，可以继续建房子
- 🎉 经济循环建立！

---

## 🐛 常见问题

### Q: 如何知道对方是否接受了交易？
A: 当前简化版本，发起方直接confirm完成。
   完整版本应该等待对方确认。

### Q: 交易被拒绝怎么办？
A: 使用 `cancel` 取消当前交易，然后可以：
   - 调整价格重新发起
   - 找其他村民交易
   - 直接与商人交易

### Q: 可以同时进行多个交易吗？
A: 当前版本一次只能有一个待处理的交易。
   完成或取消后才能发起新的。

### Q: 交易会消耗行动点吗？
A: ❌ 不消耗！交易不影响行动点，
   只有produce（生产）才消耗行动点。

---

## 🎓 学习要点

通过村民间交易，你理解了：

1. **P2P网络** - 节点间直接通信
2. **去中心化交易** - 不依赖中央服务器
3. **资源协商** - 双方协商价格和条款
4. **分布式经济** - 自由市场机制

这是真实区块链和去中心化系统的基础概念！

---

祝你交易愉快！💰

