"""
MerchantNode - Architecture 2 (REST)
提供固定Price的Item买卖服务
+ 中心化Trade管理系统
+ Price波动机制
"""

from flask import Flask, request, jsonify
import requests
import sys
import os
import threading
import time
import uuid
import random
import copy

sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))
from common.models import MERCHANT_PRICES

app = Flask(__name__)

# 全局状态
node_id = "merchant"
prices = MERCHANT_PRICES

# Trade管理系统
trade_counter = 0
active_trades = {}  # trade_id -> trade_data


@app.route('/health', methods=['GET'])
def health():
    """Health check"""
    return jsonify({'status': 'healthy', 'service': 'merchant', 'node_id': node_id})


@app.route('/prices', methods=['GET'])
def get_prices():
    """获取Price表"""
    return jsonify(prices)


@app.route('/buy', methods=['POST'])
def buy_item():
    """玩家从Merchant处BuyItem"""
    data = request.json
    buyer_id = data['buyer_id']
    item = data['item']
    quantity = data['quantity']
    
    # 检查Merchant是否Sell该Item
    if item not in prices['buy']:
        return jsonify({
            'success': False,
            'message': f'Merchant不Sell {item}'
        }), 400
    
    price = prices['buy'][item]
    total_cost = price * quantity
    
    print(f"[Merchant] {buyer_id} Buy {quantity}x {item}, 总价: {total_cost}")
    
    return jsonify({
        'success': True,
        'message': f'Sell {quantity}x {item} 给 {buyer_id}',
        'total_cost': total_cost
    })


@app.route('/sell', methods=['POST'])
def sell_item():
    """玩家向MerchantSellItem"""
    data = request.json
    seller_id = data['seller_id']
    item = data['item']
    quantity = data['quantity']
    
    # 检查Merchant是否收购该Item
    if item not in prices['sell']:
        return jsonify({
            'success': False,
            'message': f'Merchant不收购 {item}'
        }), 400
    
    price = prices['sell'][item]
    total_income = price * quantity
    
    print(f"[Merchant] 从 {seller_id} 收购 {quantity}x {item}, 支付: {total_income}")
    
    return jsonify({
        'success': True,
        'message': f'收购 {quantity}x {item} 从 {seller_id}',
        'total_income': total_income
    })


@app.route('/time/advance', methods=['POST'])
def on_time_advance():
    """TimeAdvanceNotify"""
    data = request.json
    print(f"[Merchant] TimeAdvance: Day {data['day']} {data['time_of_day']}")
    
    return jsonify({
        'success': True,
        'message': 'Time updated'
    })


# ==================== 中心化Trade系统 ====================

@app.route('/trade/create', methods=['POST'])
def create_trade():
    """CreateTrade（由发起方调用）"""
    global trade_counter
    
    data = request.json
    initiator_id = data['initiator_id']  # 发起方node_id
    initiator_address = data['initiator_address']  # 发起方地址
    target_id = data['target_id']  # 目标方node_id
    target_address = data['target_address']  # 目标方地址
    offer_type = data['offer_type']  # 'buy' or 'sell'
    item = data['item']
    quantity = data['quantity']
    price = data['price']
    
    # 生成全局唯一的TradeID
    trade_counter += 1
    trade_id = f"trade_{trade_counter}"
    
    # CreateTrade记录
    trade_data = {
        'trade_id': trade_id,
        'initiator_id': initiator_id,
        'initiator_address': initiator_address,
        'target_id': target_id,
        'target_address': target_address,
        'offer_type': offer_type,
        'item': item,
        'quantity': quantity,
        'price': price,
        'status': 'pending',  # pending -> accepted -> confirmed -> completed
        'initiator_confirmed': False,
        'target_confirmed': False,
        'created_at': time.time()
    }
    
    active_trades[trade_id] = trade_data
    
    print(f"[Merchant-Trade] CreateTrade {trade_id}: {initiator_id} -> {target_id}")
    print(f"[Merchant-Trade]   {offer_type} {quantity}x {item} for {price} gold")
    
    return jsonify({
        'success': True,
        'trade_id': trade_id,
        'message': 'Trade created successfully'
    })


@app.route('/trade/list', methods=['GET'])
def list_trades():
    """QueryTrade列表"""
    node_id_param = request.args.get('node_id')
    trade_type = request.args.get('type', 'all')  # 'pending', 'sent', 'all'
    
    if not node_id_param:
        return jsonify({'success': False, 'message': 'Missing node_id parameter'}), 400
    
    result_trades = []
    
    for trade_id, trade in active_trades.items():
        if trade_type == 'pending' and trade['target_id'] == node_id_param:
            # 收到的待HandleTrade
            result_trades.append(trade)
        elif trade_type == 'sent' and trade['initiator_id'] == node_id_param:
            # 自己发起的Trade
            result_trades.append(trade)
        elif trade_type == 'all' and (trade['initiator_id'] == node_id_param or trade['target_id'] == node_id_param):
            # 所有相关Trade
            result_trades.append(trade)
    
    return jsonify({
        'success': True,
        'trades': result_trades
    })


@app.route('/trade/accept', methods=['POST'])
def accept_trade():
    """AcceptTrade（由目标方调用）"""
    data = request.json
    trade_id = data['trade_id']
    node_id_param = data['node_id']
    
    if trade_id not in active_trades:
        return jsonify({'success': False, 'message': 'Trade not found'}), 404
    
    trade = active_trades[trade_id]
    
    # 验证是否是目标方
    if trade['target_id'] != node_id_param:
        return jsonify({'success': False, 'message': 'Only target can accept trade'}), 403
    
    # 检查状态
    if trade['status'] != 'pending':
        return jsonify({'success': False, 'message': f"Trade status is {trade['status']}, cannot accept"}), 400
    
    # 检查目标方的资源
    target_address = trade['target_address']
    try:
        # Get目标方的Villagerinformation
        response = requests.get(f"http://{target_address}/villager", timeout=5)
        if response.status_code != 200:
            return jsonify({'success': False, 'message': 'Cannot get target villager info'}), 400
        
        villager_data = response.json()
        inventory = villager_data.get('inventory', {})
        money = inventory.get('money', 0)
        items = inventory.get('items', {})
        
        # 检查资源是否足够
        if trade['offer_type'] == 'buy':
            # 发起方想买，目标方要卖，检查目标方是否有Item
            if trade['item'] not in items or items[trade['item']] < trade['quantity']:
                return jsonify({
                    'success': False,
                    'message': f"Target does not have enough {trade['item']}"
                }), 400
        else:
            # 发起方想卖，目标方要买，检查目标方是否有钱
            if money < trade['price']:
                return jsonify({
                    'success': False,
                    'message': f"Target does not have enough money"
                }), 400
        
        # UpdateTrade状态
        trade['status'] = 'accepted'
        trade['accepted_at'] = time.time()
        
        print(f"[Merchant-Trade] Trade {trade_id} 被Accept: {trade['target_id']}")
        
        return jsonify({
            'success': True,
            'message': 'Trade accepted',
            'trade': trade
        })
    
    except Exception as e:
        print(f"[Merchant-Trade] AcceptTradeFailed: {e}")
        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500


@app.route('/trade/confirm', methods=['POST'])
def confirm_trade():
    """ConfirmTrade（双方都需要调用）"""
    data = request.json
    trade_id = data['trade_id']
    node_id_param = data['node_id']
    
    if trade_id not in active_trades:
        return jsonify({'success': False, 'message': 'Trade not found'}), 404
    
    trade = active_trades[trade_id]
    
    # 检查状态
    if trade['status'] != 'accepted':
        return jsonify({'success': False, 'message': f"Trade status is {trade['status']}, must be accepted"}), 400
    
    # 确定是发起方还是目标方
    if node_id_param == trade['initiator_id']:
        trade['initiator_confirmed'] = True
        print(f"[Merchant-Trade] 发起方ConfirmTrade: {trade_id}")
    elif node_id_param == trade['target_id']:
        trade['target_confirmed'] = True
        print(f"[Merchant-Trade] 目标方ConfirmTrade: {trade_id}")
    else:
        return jsonify({'success': False, 'message': 'Invalid node_id for this trade'}), 403
    
    # 检查是否双方都Confirm
    if trade['initiator_confirmed'] and trade['target_confirmed']:
        # ExecuteTrade
        print(f"[Merchant-Trade] 双方已Confirm，ExecuteTrade: {trade_id}")
        
        try:
            # Execute原子Trade
            success = execute_trade(trade)
            
            if success:
                trade['status'] = 'completed'
                trade['completed_at'] = time.time()
                
                # 从活跃Trade中移除
                del active_trades[trade_id]
                
                print(f"[Merchant-Trade] Trade完成: {trade_id}")
                
                return jsonify({
                    'success': True,
                    'message': 'Trade completed successfully',
                    'trade': trade
                })
            else:
                return jsonify({'success': False, 'message': 'Trade execution failed'}), 500
        
        except Exception as e:
            print(f"[Merchant-Trade] TradeExecuteFailed: {e}")
            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500
    else:
        # Waiting另一方Confirm
        return jsonify({
            'success': True,
            'message': 'Confirmation recorded. Waiting for the other party.',
            'trade': trade
        })


def execute_trade(trade):
    """ExecuteTrade（原子操作）"""
    try:
        initiator_address = trade['initiator_address']
        target_address = trade['target_address']
        
        # 根据Trade类型确定谁给什么
        if trade['offer_type'] == 'buy':
            # 发起方想买
            buyer_address = initiator_address
            seller_address = target_address
        else:
            # 发起方想卖
            buyer_address = target_address
            seller_address = initiator_address
        
        # 1. 买方扣钱
        response = requests.post(
            f"http://{buyer_address}/trade/execute",
            json={
                'trade_id': trade['trade_id'],
                'action': 'pay',
                'amount': trade['price']
            },
            timeout=5
        )
        if response.status_code != 200:
            print(f"[Merchant-Trade] 买方支付Failed")
            return False
        
        # 2. 卖方扣Item
        response = requests.post(
            f"http://{seller_address}/trade/execute",
            json={
                'trade_id': trade['trade_id'],
                'action': 'remove_item',
                'item': trade['item'],
                'quantity': trade['quantity']
            },
            timeout=5
        )
        if response.status_code != 200:
            print(f"[Merchant-Trade] 卖方扣除ItemFailed")
            # 回滚买方的钱
            requests.post(
                f"http://{buyer_address}/trade/execute",
                json={
                    'trade_id': trade['trade_id'],
                    'action': 'refund',
                    'amount': trade['price']
                },
                timeout=5
            )
            return False
        
        # 3. 买方加Item
        response = requests.post(
            f"http://{buyer_address}/trade/execute",
            json={
                'trade_id': trade['trade_id'],
                'action': 'add_item',
                'item': trade['item'],
                'quantity': trade['quantity']
            },
            timeout=5
        )
        if response.status_code != 200:
            print(f"[Merchant-Trade] 买方ReceiveItemFailed")
            return False
        
        # 4. 卖方加钱
        response = requests.post(
            f"http://{seller_address}/trade/execute",
            json={
                'trade_id': trade['trade_id'],
                'action': 'receive',
                'amount': trade['price']
            },
            timeout=5
        )
        if response.status_code != 200:
            print(f"[Merchant-Trade] 卖方Receive金钱Failed")
            return False
        
        print(f"[Merchant-Trade] TradeExecuteSuccess: {trade['initiator_id']} <-> {trade['target_id']}")
        return True
    
    except Exception as e:
        print(f"[Merchant-Trade] TradeExecute异常: {e}")
        return False


@app.route('/trade/reject', methods=['POST'])
def reject_trade():
    """RejectTrade（目标方Reject）"""
    data = request.json
    trade_id = data['trade_id']
    node_id_param = data['node_id']
    
    if trade_id not in active_trades:
        return jsonify({'success': False, 'message': 'Trade not found'}), 404
    
    trade = active_trades[trade_id]
    
    # 只有目标方可以Reject
    if trade['target_id'] != node_id_param:
        return jsonify({'success': False, 'message': 'Only target can reject trade'}), 403
    
    # 只有pending状态的Trade可以Reject
    if trade['status'] != 'pending':
        return jsonify({'success': False, 'message': f"Cannot reject trade with status {trade['status']}"}), 400
    
    del active_trades[trade_id]
    
    print(f"[Merchant-Trade] Trade已Reject: {trade_id} by {node_id_param}")
    
    return jsonify({
        'success': True,
        'message': 'Trade rejected'
    })


@app.route('/trade/cancel', methods=['POST'])
def cancel_trade():
    """CancelTrade（发起方Cancel）"""
    data = request.json
    trade_id = data['trade_id']
    node_id_param = data['node_id']
    
    if trade_id not in active_trades:
        return jsonify({'success': False, 'message': 'Trade not found'}), 404
    
    trade = active_trades[trade_id]
    
    # 只有发起方可以Cancel
    if trade['initiator_id'] != node_id_param:
        return jsonify({'success': False, 'message': 'Only initiator can cancel trade'}), 403
    
    # 只有pending状态的Trade可以Cancel
    if trade['status'] != 'pending':
        return jsonify({'success': False, 'message': f"Cannot cancel trade with status {trade['status']}"}), 400
    
    del active_trades[trade_id]
    
    print(f"[Merchant-Trade] Trade已Cancel: {trade_id}")
    
    return jsonify({
        'success': True,
        'message': 'Trade cancelled'
    })


def register_to_coordinator(coordinator_addr, port):
    """Register to coordinator"""
    import time
    time.sleep(2)  # WaitingService started
    
    try:
        response = requests.post(
            f"http://{coordinator_addr}/register",
            json={
                'node_id': node_id,
                'node_type': 'merchant',
                'address': f"{os.getenv('MERCHANT_HOST', 'localhost')}:{port}"
            },
            timeout=5
        )
        
        if response.status_code == 200:
            print(f"[Merchant] SuccessRegister to coordinator: {coordinator_addr}")
        else:
            print(f"[Merchant] Registration failed: {response.status_code}")
    
    except Exception as e:
        print(f"[Merchant] 无法Connecting toCoordinator {coordinator_addr}: {e}")


def run_server(port=5001, coordinator_addr=None):
    """运行服务器"""
    print(f"[Merchant] RESTMerchantNodestarting on port {port}")
    print(f"[Merchant] SellPrice: {prices['buy']}")
    print(f"[Merchant] 收购Price: {prices['sell']}")
    
    # 在后台线程Register to coordinator
    threading.Thread(
        target=register_to_coordinator,
        args=(coordinator_addr, port),
        daemon=True
    ).start()
    
    app.run(host='0.0.0.0', port=port, debug=False)


if __name__ == '__main__':
    import argparse
    parser = argparse.ArgumentParser(description='RESTMerchantNode服务')
    parser.add_argument('--port', type=int, default=5001, help='监听端口')
    parser.add_argument('--coordinator', type=str, default=f"{os.getenv('COORDINATOR_HOST', 'localhost')}:{os.getenv('COORDINATOR_PORT', '5000')}",
                       help='Coordinator地址')
    args = parser.parse_args()
    
    run_server(args.port, args.coordinator)

