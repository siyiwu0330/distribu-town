# äº¤æ˜“ç»“ç®—Bugä¿®å¤è¯´æ˜

## ä¿®å¤çš„é—®é¢˜

### 1. äº¤æ˜“ç»“ç®—é€»è¾‘é”™è¯¯ âŒâ†’âœ…

**é—®é¢˜æè¿°**:
å½“å‘èµ·æ–¹æ‰§è¡Œ `trade node1 buy wheat 5 50` å¹¶å®Œæˆäº¤æ˜“åï¼š
- **ä¹°å®¶ï¼ˆå‘èµ·æ–¹ï¼‰**: ç»“ç®—æ­£ç¡® âœ“
  - è´§å¸: -50 âœ“
  - wheat: +5 âœ“
  
- **å–å®¶ï¼ˆæ¥æ”¶æ–¹ï¼‰**: ç»“ç®—å®Œå…¨ç›¸å âŒ
  - è´§å¸: -50ï¼ˆåº”è¯¥æ˜¯+50ï¼‰âŒ
  - wheat: +5ï¼ˆåº”è¯¥æ˜¯-5ï¼‰âŒ

**æ ¹æœ¬åŸå› **:
åœ¨ `complete_pending_trade()` ä¸­ï¼Œå‘é€ç»™æ¥æ”¶æ–¹çš„ `type` å­—æ®µè¢«é”™è¯¯åœ°è½¬æ¢äº†ï¼š

```python
# é”™è¯¯çš„ä»£ç 
'type': 'sell' if trade['type'] == 'buy' else 'buy'
```

è¿™å¯¼è‡´ï¼š
- å‘èµ·æ–¹ type='buy'ï¼ˆæˆ‘è¦ä¹°ï¼‰
- å‘é€ç»™æ¥æ”¶æ–¹ type='sell'ï¼ˆé”™è¯¯ï¼ï¼‰
- æ¥æ”¶æ–¹ç†è§£ä¸º"å¯¹æ–¹è¦å–ç»™æˆ‘"ï¼Œæ‰§è¡Œäº†ä¹°å…¥æ“ä½œ

**ä¿®å¤æ–¹æ³•**:
```python
# æ­£ç¡®çš„ä»£ç 
'type': trade['type']  # ç›´æ¥ä¼ é€’ï¼Œä¸éœ€è¦è½¬æ¢
```

**é€»è¾‘è¯´æ˜**:
- å‘èµ·æ–¹ type='buy' â†’ æˆ‘è¦ä¹°ä½ çš„ä¸œè¥¿
- æ¥æ”¶æ–¹æ”¶åˆ° type='buy' â†’ å¯¹æ–¹è¦ä¹°æˆ‘çš„ä¸œè¥¿ï¼ˆæˆ‘æ˜¯å–å®¶ï¼‰
- æ¥æ”¶æ–¹æ‰§è¡Œï¼š`remove_item()` + `add_money()` âœ“

---

### 2. ç¼ºå°‘Confirmæç¤º âŒâ†’âœ…

**é—®é¢˜æè¿°**:
åœ¨äº¤æ˜“æµç¨‹ä¸­ï¼š
1. å‘èµ·æ–¹å‘é€è¯·æ±‚ â†’ æ˜¾ç¤º"ç­‰å¾…å¯¹æ–¹æ¥å—"
2. æ¥æ”¶æ–¹accept â†’ **å‘èµ·æ–¹æ²¡æœ‰æ”¶åˆ°ä»»ä½•é€šçŸ¥** âŒ
3. ç”¨æˆ·ä¸çŸ¥é“ä½•æ—¶åº”è¯¥è¾“å…¥ `confirm`

**ä¿®å¤æ–¹æ³•**:
æ·»åŠ äº†è‡ªåŠ¨æ£€æŸ¥æœºåˆ¶ `check_my_pending_trade_status()`ï¼š

1. **åœ¨ä¸»å¾ªç¯ä¸­è‡ªåŠ¨æ£€æŸ¥**ï¼šæ¯æ¬¡ç”¨æˆ·è¾“å…¥å‘½ä»¤å‰æ£€æŸ¥ä¸€æ¬¡
2. **æŸ¥è¯¢å¯¹æ–¹èŠ‚ç‚¹**ï¼šé€šè¿‡ `/trade/pending` æŸ¥è¯¢äº¤æ˜“çŠ¶æ€
3. **ä¸»åŠ¨æç¤º**ï¼šå½“æ£€æµ‹åˆ°å¯¹æ–¹å·²acceptæ—¶ï¼Œæ˜¾ç¤ºé†’ç›®æç¤º

**æç¤ºæ•ˆæœ**:
```
============================================================
ğŸ‰ å¯¹æ–¹å·²æ¥å—ä½ çš„äº¤æ˜“è¯·æ±‚ï¼
============================================================
äº¤æ˜“è¯¦æƒ…:
  è´­ä¹° 5x wheat
  æ”¯ä»˜ 50é‡‘å¸

ğŸ’¡ è¾“å…¥ 'confirm' å®Œæˆäº¤æ˜“ï¼Œæˆ–è¾“å…¥ 'cancel' å–æ¶ˆ
============================================================
```

---

## ä¿®å¤åçš„æ­£ç¡®æµç¨‹

### Terminal 2 (å‘èµ·æ–¹ - ä¹°å®¶)
```bash
[Day 1 - morning] > trade node1 buy wheat 5 50
ğŸ“¤ å‘ node1 å‘é€äº¤æ˜“è¯·æ±‚...
âœ“ äº¤æ˜“è¯·æ±‚å·²å‘é€
  ä½ æƒ³ä» node1 è´­ä¹° 5x wheat, å‡ºä»· 50é‡‘å¸

â³ ç­‰å¾… node1 æ¥å—æˆ–æ‹’ç»...

# å¯¹æ–¹acceptåï¼Œè‡ªåŠ¨æ˜¾ç¤ºï¼š
============================================================
ğŸ‰ å¯¹æ–¹å·²æ¥å—ä½ çš„äº¤æ˜“è¯·æ±‚ï¼
============================================================
äº¤æ˜“è¯¦æƒ…:
  è´­ä¹° 5x wheat
  æ”¯ä»˜ 50é‡‘å¸

ğŸ’¡ è¾“å…¥ 'confirm' å®Œæˆäº¤æ˜“ï¼Œæˆ–è¾“å…¥ 'cancel' å–æ¶ˆ
============================================================

[Day 1 - morning] > confirm

æ­£åœ¨ä¸ node1 å®Œæˆäº¤æ˜“...

âœ“ äº¤æ˜“å®Œæˆï¼
  ä½ ä» node1 è´­ä¹°äº† 5x wheat
  æ”¯ä»˜: 50é‡‘å¸

==================================================
  test2 - chef
==================================================
ğŸ’° è´§å¸: 50    # 100 - 50 âœ“
ğŸ“¦ ç‰©å“:
   - wheat: 5  # 0 + 5 âœ“
==================================================
```

### Terminal 1 (æ¥æ”¶æ–¹ - å–å®¶)
```bash
[Day 1 - morning] > trades

[1] äº¤æ˜“ID: trade_0
    æ¥è‡ª: test2
    ç±»å‹: å¯¹æ–¹æƒ³è´­ä¹°
    ç‰©å“: 5x wheat
    å‡ºä»·: 50é‡‘å¸

[Day 1 - morning] > accept trade_0

âœ“ äº¤æ˜“å·²æ¥å—ï¼
  ç­‰å¾… test2 å®Œæˆäº¤æ˜“...

# å¯¹æ–¹confirmåï¼Œè‡ªåŠ¨ç»“ç®—ï¼š

[Day 1 - morning] > info

==================================================
  test1 - farmer
==================================================
ğŸ’° è´§å¸: 130   # 80 + 50 âœ“
ğŸ“¦ ç‰©å“:
   - seed: 9
   - wheat: 0   # 5 - 5 âœ“
==================================================
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹ 1: Buyäº¤æ˜“
```bash
# åˆå§‹çŠ¶æ€
ä¹°å®¶: è´§å¸100, wheat 0
å–å®¶: è´§å¸80, wheat 5

# äº¤æ˜“: ä¹°å®¶è´­ä¹°5ä¸ªwheatï¼Œå‡ºä»·50é‡‘å¸

# é¢„æœŸç»“æœ
ä¹°å®¶: è´§å¸50 (100-50), wheat 5 (0+5) âœ“
å–å®¶: è´§å¸130 (80+50), wheat 0 (5-5) âœ“
```

### æµ‹è¯•ç”¨ä¾‹ 2: Selläº¤æ˜“
```bash
# åˆå§‹çŠ¶æ€
å–å®¶: è´§å¸100, bread 10
ä¹°å®¶: è´§å¸200, bread 0

# äº¤æ˜“: å–å®¶å‡ºå”®3ä¸ªbreadï¼Œè¦ä»·30é‡‘å¸

# é¢„æœŸç»“æœ
å–å®¶: è´§å¸130 (100+30), bread 7 (10-3) âœ“
ä¹°å®¶: è´§å¸170 (200-30), bread 3 (0+3) âœ“
```

---

## æŠ€æœ¯ç»†èŠ‚

### Typeå­—æ®µçš„å«ä¹‰

åœ¨P2Päº¤æ˜“ç³»ç»Ÿä¸­ï¼Œ`type` å­—æ®µè¡¨ç¤º**å‘èµ·æ–¹çš„æ„å›¾**ï¼š

- `type='buy'`: å‘èµ·æ–¹æƒ³è´­ä¹°
  - å‘èµ·æ–¹ï¼šæ‰£é’± + åŠ ç‰©å“
  - æ¥æ”¶æ–¹ï¼šæ‰£ç‰©å“ + åŠ é’±
  
- `type='sell'`: å‘èµ·æ–¹æƒ³å‡ºå”®
  - å‘èµ·æ–¹ï¼šæ‰£ç‰©å“ + åŠ é’±
  - æ¥æ”¶æ–¹ï¼šæ‰£é’± + åŠ ç‰©å“

### çŠ¶æ€æ£€æŸ¥æœºåˆ¶

```python
def check_my_pending_trade_status(self):
    """æ£€æŸ¥è‡ªå·±å‘èµ·çš„äº¤æ˜“çŠ¶æ€"""
    if not self.pending_trade:
        return
    
    # é¿å…é‡å¤æç¤º
    if self.pending_trade.get('status') == 'ready_to_confirm':
        return
    
    # å‘å¯¹æ–¹æŸ¥è¯¢äº¤æ˜“çŠ¶æ€
    response = requests.get(
        f"http://{self.pending_trade['target_address']}/trade/pending",
        timeout=2
    )
    
    # æ£€æŸ¥äº¤æ˜“æ˜¯å¦è¢«accept
    for trade in pending_trades:
        if trade['status'] == 'accepted':
            # æ˜¾ç¤ºæç¤º
            print("ğŸ‰ å¯¹æ–¹å·²æ¥å—ä½ çš„äº¤æ˜“è¯·æ±‚ï¼")
            # æ ‡è®°ä¸ºå·²æç¤º
            self.pending_trade['status'] = 'ready_to_confirm'
```

---

## ç›¸å…³æ–‡ä»¶

- `architecture2_rest/interactive_cli.py`
  - `complete_pending_trade()` - ä¿®å¤typeä¼ é€’é€»è¾‘
  - `check_my_pending_trade_status()` - æ–°å¢çŠ¶æ€æ£€æŸ¥
  - ä¸»å¾ªç¯ - æ·»åŠ è‡ªåŠ¨æ£€æŸ¥è°ƒç”¨

- `architecture2_rest/villager.py`
  - `/trade/complete` - å¤„ç†äº¤æ˜“å®Œæˆ
  - `/trade/accept` - æ ‡è®°äº¤æ˜“ä¸ºå·²æ¥å—

---

## æ€»ç»“

âœ… **ç»“ç®—é€»è¾‘ä¿®å¤**: ä¹°å–åŒæ–¹çš„è´§å¸å’Œç‰©å“ç°åœ¨éƒ½èƒ½æ­£ç¡®æ›´æ–°  
âœ… **ç”¨æˆ·ä½“éªŒæ”¹å–„**: è‡ªåŠ¨æç¤ºç”¨æˆ·ä½•æ—¶å¯ä»¥confirmï¼Œé¿å…å›°æƒ‘  
âœ… **å‘åå…¼å®¹**: æ‰€æœ‰ä¿®æ”¹ä¸å½±å“ç°æœ‰åŠŸèƒ½  

ç°åœ¨P2Päº¤æ˜“ç³»ç»Ÿå®Œå…¨å¯ç”¨ï¼ğŸ‰

